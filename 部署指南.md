# ClinicSim-AI 部署指南

## 🎯 部署概述

本指南詳細說明如何在 Lemonade AMD AI PC 環境中部署 ClinicSim-AI 系統，以及團隊成員如何在本地開發環境中進行開發。

## 🖥️ Lemonade AMD AI PC 部署

### 前置準備

#### 1. 在本地開發環境中準備
```bash
# 1. 確保專案完整
cd ClinicSim-AI
git status

# 2. 建立 RAG 索引
python build_index.py

# 3. 驗證索引建立成功
ls -la faiss_index/
# 應該看到 index.faiss 和 index.pkl 檔案

# 4. 打包索引檔案
tar -czf faiss_index.tar.gz faiss_index/
# 或使用 zip
zip -r faiss_index.zip faiss_index/
```

#### 2. 準備部署檔案
需要上傳到 AMD AI PC 的檔案：
- 整個專案資料夾
- `faiss_index.tar.gz` 或 `faiss_index.zip`
- `requirements.txt`
- 所有 Python 檔案

### 部署步驟

#### 1. 上傳專案檔案
```bash
# 使用 scp 或其他方式上傳到 AMD AI PC
scp -r ClinicSim-AI/ user@amd-ai-pc:/path/to/deployment/
scp faiss_index.tar.gz user@amd-ai-pc:/path/to/deployment/ClinicSim-AI/
```

#### 2. 在 AMD AI PC 上設定環境
```bash
# 連接到 AMD AI PC
ssh user@amd-ai-pc

# 進入專案目錄
cd /path/to/deployment/ClinicSim-AI

# 解壓縮 RAG 索引
tar -xzf faiss_index.tar.gz
# 或
unzip faiss_index.zip

# 驗證索引檔案
ls -la faiss_index/
```

#### 3. 安裝 Python 依賴
```bash
# 建立虛擬環境
python3 -m venv venv

# 啟動虛擬環境
source venv/bin/activate

# 安裝依賴
pip install --upgrade pip
pip install -r requirements.txt
```

#### 4. 設定 Lemonade 環境
```bash
# 建立 .env 檔案（如果需要）
touch .env

# 在 Lemonade 環境中，以下變數會自動設定：
# - PATH_A_DEMO = True
# - lemonade 模組會自動載入
```

#### 5. 驗證 RAG 系統
```bash
# 測試 RAG 系統是否正常載入
python -c "
from rag_handler import rag_system
print('RAG 系統狀態:', rag_system.vector_store is not None)
result = rag_system.search('ECG 心電圖的重要性')
print('搜尋測試:', '成功' if result else '失敗')
"
```

#### 6. 啟動系統
```bash
# 在 Lemonade 環境中啟動
python server.py
```

### 驗證部署

#### 1. 檢查系統狀態
```bash
# 檢查進程
ps aux | grep python

# 檢查日誌
tail -f server.log  # 如果有日誌檔案
```

#### 2. 測試 API 端點
```bash
# 測試基本連接
curl http://localhost:5001/health  # 如果有健康檢查端點

# 測試 AI 病人功能
curl -X POST http://localhost:5001/ask_patient \
  -H "Content-Type: application/json" \
  -d '{"history": [{"role": "user", "content": "你好"}], "case_id": "case_chest_pain_acs_01"}'
```

#### 3. 測試 RAG 功能
```bash
# 測試詳細報告生成
curl -X POST http://localhost:5001/get_detailed_report \
  -H "Content-Type: application/json" \
  -d '{"full_conversation": [{"role": "user", "content": "測試"}], "case_id": "case_chest_pain_acs_01"}'
```

## 💻 本地開發環境

### 環境設定

#### 1. 系統要求
- Python 3.8+
- 8GB+ RAM
- 網路連線
- Git

#### 2. 克隆專案
```bash
git clone <repository-url>
cd ClinicSim-AI
```

#### 3. 建立虛擬環境
```bash
# 建立虛擬環境
python -m venv venv

# 啟動虛擬環境
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

#### 4. 安裝依賴
```bash
# 安裝基本依賴
pip install -r requirements.txt

# 如果遇到依賴問題，可以嘗試
pip install --upgrade pip
pip install -r requirements.txt --force-reinstall
```

#### 5. 設定環境變數
建立 `.env` 檔案：
```env
OLLAMA_HOST=http://127.0.0.1:11434
OLLAMA_MODEL=llama3:8b
```

### 開發流程

#### 1. 建立 RAG 索引
```bash
# 確保 documents/ 資料夾中有臨床指引文件
python build_index.py
```

#### 2. 啟動 Ollama (可選)
```bash
# 如果使用本地 Ollama 模型
ollama serve
ollama pull llama3:8b
```

#### 3. 啟動開發伺服器
```bash
# 終端 1：啟動後端
python server.py

# 終端 2：啟動前端
streamlit run app.py
```

#### 4. 開發測試
- 前端界面：http://localhost:8501
- 後端 API：http://localhost:5001

### 開發注意事項

#### 1. 代碼修改
- 修改後端代碼後需要重啟 `server.py`
- 修改前端代碼後 Streamlit 會自動重載
- 修改 RAG 相關代碼需要重新建立索引

#### 2. 測試新功能
```bash
# 測試 RAG 系統
python -c "
from rag_handler import rag_system
result = rag_system.search('你的測試查詢')
print(result)
"

# 測試 API 端點
python -c "
import requests
response = requests.post('http://localhost:5001/ask_patient', 
                        json={'history': [], 'case_id': 'case_chest_pain_acs_01'})
print(response.json())
"
```

#### 3. 添加新案例
1. 在 `cases/` 中建立新的 JSON 檔案
2. 參考現有案例的格式
3. 更新 `app.py` 中的 `CASE_ID`

#### 4. 添加新指引
1. 將文件放入 `documents/` 資料夾
2. 重新執行 `python build_index.py`
3. 重啟系統

## 🔄 更新部署

### 代碼更新
```bash
# 1. 在本地更新代碼
git pull origin main
# 或
git checkout <branch-name>

# 2. 重新建立索引（如果有新的指引文件）
python build_index.py

# 3. 打包更新
tar -czf faiss_index.tar.gz faiss_index/

# 4. 上傳到 AMD AI PC
scp -r . user@amd-ai-pc:/path/to/deployment/ClinicSim-AI/
scp faiss_index.tar.gz user@amd-ai-pc:/path/to/deployment/ClinicSim-AI/
```

### 在 AMD AI PC 上更新
```bash
# 1. 停止現有服務
pkill -f "python server.py"

# 2. 更新代碼
cd /path/to/deployment/ClinicSim-AI
git pull origin main

# 3. 更新索引
tar -xzf faiss_index.tar.gz

# 4. 重啟服務
python server.py
```

## 🐛 故障排除

### 常見問題

#### 1. RAG 索引問題
```bash
# 檢查索引檔案
ls -la faiss_index/
# 應該有 index.faiss 和 index.pkl

# 重新建立索引
rm -rf faiss_index/
python build_index.py
```

#### 2. 依賴問題
```bash
# 清理並重新安裝
pip uninstall -y -r requirements.txt
pip install -r requirements.txt
```

#### 3. 記憶體不足
```bash
# 檢查記憶體使用
free -h
# 或
top -o %MEM

# 減少 RAG 索引大小
# 編輯 build_index.py 中的 chunk_size 參數
```

#### 4. 網路問題
```bash
# 檢查網路連接
ping google.com
curl -I https://huggingface.co

# 檢查防火牆設定
sudo ufw status
```

### 日誌檢查
```bash
# 查看系統日誌
journalctl -u your-service-name

# 查看應用日誌
tail -f /var/log/your-app.log

# 查看 Python 錯誤
python server.py 2>&1 | tee server.log
```

## 📊 監控與維護

### 系統監控
```bash
# 檢查系統資源
htop
# 或
top

# 檢查磁碟空間
df -h

# 檢查網路連接
netstat -tulpn
```

### 定期維護
1. **清理日誌檔案**
2. **更新依賴套件**
3. **備份 RAG 索引**
4. **檢查系統效能**

## 📞 支援聯絡

### 技術支援
- 查看本部署指南
- 檢查專案文檔
- 聯繫開發團隊

### 緊急處理
如果系統無法啟動：
1. 檢查日誌檔案
2. 重啟服務
3. 重新部署
4. 聯繫技術支援

---

**最後更新**：2024年9月
**版本**：v1.0.0
**維護者**：ClinicSim-AI 開發團隊
