name: ðŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # ä»£ç¢¼è³ªé‡æª¢æŸ¥
  lint-and-format:
    name: ðŸ” ä»£ç¢¼è³ªé‡æª¢æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ðŸ” Flake8 ä»£ç¢¼æª¢æŸ¥
        run: |
          flake8 src/ --max-line-length=120 --count --statistics

      - name: ðŸŽ¨ Black ä»£ç¢¼æ ¼å¼æª¢æŸ¥
        run: |
          black --check src/

      - name: ðŸ”¬ MyPy é¡žåž‹æª¢æŸ¥
        run: |
          mypy src/ --ignore-missing-imports

  # å–®å…ƒæ¸¬è©¦
  unit-tests:
    name: ðŸ§ª å–®å…ƒæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ðŸ§ª é‹è¡Œå–®å…ƒæ¸¬è©¦
        run: |
          python scripts/run_tests.py --type unit

      - name: ðŸ“Š ç”Ÿæˆæ¸¬è©¦å ±å‘Š
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: å–®å…ƒæ¸¬è©¦å ±å‘Š
          path: test-results.xml
          reporter: java-junit

  # é›†æˆæ¸¬è©¦
  integration-tests:
    name: ðŸ”— é›†æˆæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      # æ¨¡æ“¬ Ollama æœå‹™
      ollama:
        image: ollama/ollama:latest
        ports:
          - 11434:11434
        options: --health-cmd "curl -f http://localhost:11434/api/tags || exit 1" --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ðŸš€ å•Ÿå‹•å¾Œç«¯æœå‹™
        run: |
          python main.py &
          sleep 10
        env:
          OLLAMA_HOST: http://localhost:11434
          HOST: 0.0.0.0
          PORT: 5001

      - name: ðŸ”— é‹è¡Œé›†æˆæ¸¬è©¦
        run: |
          python scripts/run_tests.py --type integration

  # æ¸¬è©¦è¦†è“‹çŽ‡
  coverage:
    name: ðŸ“Š æ¸¬è©¦è¦†è“‹çŽ‡
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ðŸ“Š é‹è¡Œè¦†è“‹çŽ‡æ¸¬è©¦
        run: |
          python scripts/run_tests.py --type coverage

      - name: ðŸ“ˆ ä¸Šå‚³è¦†è“‹çŽ‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # å¤šå¹³å°æ¸¬è©¦
  cross-platform-tests:
    name: ðŸŒ å¤šå¹³å°æ¸¬è©¦
    runs-on: ${{ matrix.os }}
    needs: lint-and-format
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']
        exclude:
          - os: windows-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.9'

    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ðŸ§ª é‹è¡Œå¿«é€Ÿæ¸¬è©¦
        run: |
          python scripts/run_tests.py --type quick

  # å®‰å…¨æŽƒæ
  security-scan:
    name: ðŸ”’ å®‰å…¨æŽƒæ
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£å®‰å…¨æŽƒæå·¥å…·
        run: |
          pip install safety bandit

      - name: ðŸ”’ ä¾è³´å®‰å…¨æª¢æŸ¥
        run: |
          safety check -r requirements.txt

      - name: ðŸ›¡ï¸ ä»£ç¢¼å®‰å…¨æŽƒæ
        run: |
          bandit -r src/ -f json -o bandit-report.json

      - name: ðŸ“Š ä¸Šå‚³å®‰å…¨å ±å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: bandit-report.json

  # æ§‹å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: ðŸš€ æ§‹å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, coverage]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ðŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ³ æ§‹å»º Docker æ˜ åƒ
        run: |
          docker build -t clinic-sim-ai:${{ github.sha }} .
          docker build -t clinic-sim-ai:latest .

      - name: ðŸ·ï¸ æ¨™è¨˜ Docker æ˜ åƒ
        run: |
          docker tag clinic-sim-ai:${{ github.sha }} ghcr.io/${{ github.repository }}:latest
          docker tag clinic-sim-ai:${{ github.sha }} ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: ðŸ“¤ æŽ¨é€åˆ° GitHub Container Registry
        if: github.event_name != 'pull_request'
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/${{ github.repository }}:latest
          docker push ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: ðŸŽ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "Docker æ˜ åƒ: ghcr.io/${{ github.repository }}:latest"

  # æ¸¬è©¦ç¸½çµ
  test-summary:
    name: ðŸ“‹ æ¸¬è©¦ç¸½çµ
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, coverage, cross-platform-tests, security-scan]
    if: always()
    
    steps:
      - name: ðŸ“Š ç”Ÿæˆæ¸¬è©¦ç¸½çµ
        run: |
          echo "## ðŸ§ª æ¸¬è©¦ç¸½çµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ¸¬è©¦é¡žåž‹ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å–®å…ƒæ¸¬è©¦ | ${{ needs.unit-tests.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| é›†æˆæ¸¬è©¦ | ${{ needs.integration-tests.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è¦†è“‹çŽ‡æ¸¬è©¦ | ${{ needs.coverage.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å¤šå¹³å°æ¸¬è©¦ | ${{ needs.cross-platform-tests.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨æŽƒæ | ${{ needs.security-scan.result == 'success' && 'âœ… é€šéŽ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ æ‰€æœ‰æ¸¬è©¦å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
