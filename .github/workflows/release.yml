name: ğŸš€ Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  # å‰µå»º Release
  create-release:
    name: ğŸ“¦ å‰µå»º Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ æå–ç‰ˆæœ¬è™Ÿ
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}"

      - name: ğŸ“‹ ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # ç”Ÿæˆè®Šæ›´æ—¥èªŒ
          CHANGELOG="## ğŸ‰ æ–°ç‰ˆæœ¬ç™¼å¸ƒ\n\n"
          CHANGELOG+="**ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}\n\n"
          
          # ç²å–æœ€è¿‘çš„æäº¤
          COMMITS=$(git log --pretty=format:"- %s (%h)" --since="1 month ago")
          CHANGELOG+="### ğŸ“ æœ€è¿‘çš„è®Šæ›´\n$COMMITS\n\n"
          
          # æ·»åŠ å®‰è£èªªæ˜
          CHANGELOG+="### ğŸ“¦ å®‰è£æ–¹å¼\n\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="# å…‹éš†å°ˆæ¡ˆ\n"
          CHANGELOG+="git clone https://github.com/${{ github.repository }}.git\n"
          CHANGELOG+="cd ClinicSim-AI\n\n"
          CHANGELOG+="# å®‰è£ä¾è³´\n"
          CHANGELOG+="pip install -r requirements.txt\n\n"
          CHANGELOG+="# å•Ÿå‹•æ‡‰ç”¨\n"
          CHANGELOG+="python main.py\n"
          CHANGELOG+="\`\`\`\n\n"
          
          # æ·»åŠ  Docker èªªæ˜
          CHANGELOG+="### ğŸ³ Docker å®‰è£\n\n"
          CHANGELOG+="\`\`\`bash\n"
          CHANGELOG+="docker run -p 8501:8501 -p 5001:5001 ghcr.io/${{ github.repository }}:latest\n"
          CHANGELOG+="\`\`\`\n\n"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ å‰µå»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: ClinicSim-AI ${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.changelog }}
          draft: false
          prerelease: false

  # æ§‹å»º Docker æ˜ åƒ
  build-docker:
    name: ğŸ³ æ§‹å»º Docker æ˜ åƒ
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ³ è¨­ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” ç™»éŒ„åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ æ§‹å»ºä¸¦æ¨é€ Docker æ˜ åƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}
            ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}-amd64
            ghcr.io/${{ github.repository }}:${{ needs.create-release.outputs.version }}-arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # æ§‹å»ºåˆ†ç™¼åŒ…
  build-distributions:
    name: ğŸ“¦ æ§‹å»ºåˆ†ç™¼åŒ…
    runs-on: ${{ matrix.os }}
    needs: create-release
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11']
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ è¨­ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£æ§‹å»ºå·¥å…·
        run: |
          python -m pip install --upgrade pip
          pip install build wheel twine

      - name: ğŸ—ï¸ æ§‹å»ºåˆ†ç™¼åŒ…
        run: |
          python -m build

      - name: ğŸ“¤ ä¸Šå‚³åˆ†ç™¼åŒ…åˆ° Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: dist/
          asset_name: ClinicSim-AI-${{ needs.create-release.outputs.version }}-${{ matrix.os }}-python${{ matrix.python-version }}.zip
          asset_content_type: application/zip

  # éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
  deploy-staging:
    name: ğŸ§ª éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [build-docker, build-distributions]
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸš€ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ..."
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}"
          echo "Docker æ˜ åƒ: ghcr.io/${{ github.repository }}:${{ github.event.inputs.version || github.ref_name }}"
          
          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„éƒ¨ç½²è…³æœ¬
          # ä¾‹å¦‚ï¼šéƒ¨ç½²åˆ° Kubernetesã€AWSã€æˆ–å…¶ä»–é›²ç«¯å¹³å°

      - name: ğŸ§ª é‹è¡Œéƒ¨ç½²å¾Œæ¸¬è©¦
        run: |
          echo "ğŸ§ª é‹è¡Œéƒ¨ç½²å¾Œæ¸¬è©¦..."
          # é€™è£¡å¯ä»¥æ·»åŠ éƒ¨ç½²å¾Œçš„å¥åº·æª¢æŸ¥

  # éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ (åƒ…é™ main åˆ†æ”¯çš„æ­£å¼ç‰ˆæœ¬)
  deploy-production:
    name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/main' && !contains(github.event.inputs.version || github.ref_name, 'rc') && !contains(github.event.inputs.version || github.ref_name, 'beta') && !contains(github.event.inputs.version || github.ref_name, 'alpha')
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
        run: |
          echo "ğŸŒŸ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}"
          echo "Docker æ˜ åƒ: ghcr.io/${{ github.repository }}:${{ github.event.inputs.version || github.ref_name }}"
          
          # é€™è£¡å¯ä»¥æ·»åŠ å¯¦éš›çš„ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²è…³æœ¬

      - name: ğŸ“¢ ç™¼é€éƒ¨ç½²é€šçŸ¥
        run: |
          echo "ğŸ“¢ ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å®Œæˆï¼"
          echo "ç‰ˆæœ¬: ${{ github.event.inputs.version || github.ref_name }}"
          echo "è¨ªå•åœ°å€: https://clinic-sim-ai.example.com"

  # Release ç¸½çµ
  release-summary:
    name: ğŸ“‹ Release ç¸½çµ
    runs-on: ubuntu-latest
    needs: [create-release, build-docker, build-distributions, deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”Ÿæˆ Release ç¸½çµ
        run: |
          echo "## ğŸš€ Release ç¸½çµ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: ${{ github.event.inputs.version || github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ­¥é©Ÿ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å‰µå»º Release | ${{ needs.create-release.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ§‹å»º Docker | ${{ needs.build-docker.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ§‹å»ºåˆ†ç™¼åŒ… | ${{ needs.build-distributions.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ¸¬è©¦ç’°å¢ƒéƒ¨ç½² | ${{ needs.deploy-staging.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½² | ${{ needs.deploy-production.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ Release æµç¨‹å®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
