# ClinicSim-AI 專案架構說明

## 🏗️ 架構重構總結

本專案已從單體架構重構為模組化的分層架構，實現了關注點分離和更好的可維護性。

## 📊 架構層次圖

```
┌─────────────────────────────────────────────────────────────┐
│                    前端層 (Frontend Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  Streamlit App (app_new.py)                                │
│  ├── SidebarComponent      ├── ChatInterfaceComponent      │
│  ├── ReportDisplayComponent├── VitalSignsComponent         │
│  └── CoverageMeterComponent└── BaseComponent               │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    API 層 (API Layer)                        │
├─────────────────────────────────────────────────────────────┤
│  Flask Routes (routes.py)                                  │
│  ├── /ask_patient         ├── /get_feedback_report         │
│  ├── /get_detailed_report ├── /cases                      │
│  └── /rag/status         └── Error Handlers               │
│                                                            │
│  Dependencies (dependencies.py)                           │
│  └── 依賴注入和服務管理                                      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                 服務層 (Service Layer)                        │
├─────────────────────────────────────────────────────────────┤
│  AIService         ├── CaseService        ├── RAGService    │
│  ├── OllamaAI      ├── 案例載入管理        ├── 向量搜尋      │
│  ├── LemonadeAI    ├── 案例緩存          ├── 引註生成      │
│  └── MockAI        └── 案例驗證          └── 索引管理      │
│                                                            │
│  ConversationService├── ReportService                      │
│  ├── 對話管理       ├── 報告生成                           │
│  ├── 覆蓋率計算     ├── LLM 整合                          │
│  └── 生命體徵更新   └── 引註處理                           │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                  模型層 (Model Layer)                         │
├─────────────────────────────────────────────────────────────┤
│  Case Models        ├── Conversation Models                 │
│  ├── Case           ├── Conversation                       │
│  ├── CaseData       ├── Message                            │
│  ├── PatientProfile ├── MessageRole                        │
│  └── AIInstructions └── ConversationState                  │
│                                                            │
│  Report Models      ├── VitalSigns Models                  │
│  ├── Report         ├── VitalSigns                         │
│  ├── Citation       └── 生命體徵數據                        │
│  └── ReportType                                            │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                 工具層 (Utility Layer)                        │
├─────────────────────────────────────────────────────────────┤
│  Text Processing    ├── Validation       ├── File Utils     │
│  ├── 引註高亮       ├── 數據驗證         ├── 檔案操作       │
│  ├── 關鍵字提取     ├── 路徑驗證         ├── 目錄管理       │
│  └── 文字清理       └── 格式檢查         └── 備份功能       │
│                                                            │
│  Exception Handling                                        │
│  ├── ClinicSimError ├── CaseNotFoundError                  │
│  ├── AIServiceError ├── RAGServiceError                    │
│  └── 統一錯誤處理    └── 詳細錯誤日誌                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                 配置層 (Configuration Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  Settings (Pydantic BaseSettings)                          │
│  ├── 應用程式設定    ├── AI 模型設定                        │
│  ├── 伺服器設定      ├── RAG 設定                          │
│  ├── 路徑設定        ├── 案例設定                          │
│  └── 環境變數載入    └── 類型安全驗證                       │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 數據流圖

```
用戶輸入 → Streamlit 前端 → Flask API → 服務層 → 模型層 → 數據處理 → 回應
    ↓           ↓           ↓         ↓        ↓        ↓        ↑
  UI 組件   狀態管理    路由處理   業務邏輯   數據驗證   工具函式   格式化
    ↓           ↓           ↓         ↓        ↓        ↓        ↑
  渲染       Session    依賴注入   服務調用   模型轉換  文字處理    JSON
```

## 🎯 核心設計模式

### 1. 分層架構 (Layered Architecture)
- **表現層**: Streamlit 前端組件
- **應用層**: Flask API 路由
- **業務層**: 各種服務類別
- **數據層**: Pydantic 模型
- **基礎層**: 工具函式和配置

### 2. 依賴注入 (Dependency Injection)
```python
# 所有服務通過統一的依賴管理器注入
deps = get_dependencies()
ai_service = deps['ai_service']
case_service = deps['case_service']
```

### 3. 工廠模式 (Factory Pattern)
```python
# AI 服務工廠根據配置創建不同類型的服務
ai_service = AIServiceFactory.create_from_config(settings)
```

### 4. 單例模式 (Singleton Pattern)
```python
# 配置和服務使用單例模式確保一致性
settings = get_settings()  # 單例
ai_service = get_ai_service(settings)  # 單例
```

### 5. 策略模式 (Strategy Pattern)
```python
# 不同的 AI 提供者實現相同的接口
class AIService(ABC):
    @abstractmethod
    def chat(self, messages): pass

class OllamaAIService(AIService): ...
class LemonadeAIService(AIService): ...
```

## 🚀 新架構的優勢

### 1. 可維護性 (Maintainability)
- **模組化設計**: 每個模組專注於特定職責
- **清晰的依賴關係**: 通過依賴注入管理服務關係
- **統一的錯誤處理**: 自定義異常類別層次結構

### 2. 可擴展性 (Scalability)
- **插件式架構**: 新的 AI 提供者可以輕鬆添加
- **組件化前端**: 新的 UI 組件可以獨立開發
- **服務化設計**: 新的業務邏輯可以封裝為服務

### 3. 可測試性 (Testability)
- **依賴注入**: 便於模擬和測試
- **關注點分離**: 每個層次可以獨立測試
- **純函式設計**: 工具函式易於單元測試

### 4. 可配置性 (Configurability)
- **環境變數支援**: 不同環境使用不同配置
- **類型安全**: Pydantic 提供配置驗證
- **動態載入**: 配置變更無需重啟應用程式

## 🔧 技術棧

### 後端技術
- **Flask**: Web 框架
- **Pydantic**: 數據驗證和設定管理
- **LangChain**: RAG 系統
- **FAISS**: 向量搜尋
- **Ollama**: 本地 LLM

### 前端技術
- **Streamlit**: Web 應用程式框架
- **組件化設計**: 可重用的 UI 組件
- **狀態管理**: Session state 管理

### 開發工具
- **類型提示**: 提高代碼可讀性
- **錯誤處理**: 統一的異常處理機制
- **日誌記錄**: 詳細的運行時日誌
- **配置管理**: 環境變數和檔案配置

## 📈 性能優化

### 1. 緩存策略
- **案例緩存**: 載入的案例會被緩存
- **服務單例**: 避免重複創建服務實例
- **RAG 索引**: 向量索引載入一次後重用

### 2. 異步處理
- **非阻塞 API**: Flask 路由設計為非阻塞
- **後台任務**: 長時間運行的任務可以異步處理

### 3. 資源管理
- **連接池**: AI 服務連接可以池化
- **記憶體優化**: 大對象及時釋放

## 🛡️ 安全性考慮

### 1. 輸入驗證
- **Pydantic 驗證**: 所有輸入數據都經過驗證
- **路徑安全**: 防止路徑遍歷攻擊
- **SQL 注入防護**: 使用參數化查詢

### 2. 錯誤處理
- **敏感資訊保護**: 錯誤訊息不洩露敏感資訊
- **日誌安全**: 避免在日誌中記錄敏感數據

### 3. 配置安全
- **環境變數**: 敏感配置通過環境變數管理
- **檔案權限**: 配置檔案有適當的權限設定

## 🔮 未來擴展方向

### 1. 微服務架構
- 將不同服務拆分為獨立的微服務
- 使用 API Gateway 統一管理
- 支援服務發現和負載均衡

### 2. 容器化部署
- Docker 容器化
- Kubernetes 編排
- CI/CD 流水線

### 3. 監控和觀測性
- 應用程式性能監控 (APM)
- 分散式追蹤
- 指標收集和告警

### 4. 數據持久化
- 資料庫集成 (PostgreSQL/MongoDB)
- 快取層 (Redis)
- 檔案存儲 (MinIO/S3)

---

## 📝 總結

新的架構設計實現了：

✅ **關注點分離**: 每層專注於特定職責  
✅ **模組化設計**: 組件可以獨立開發和測試  
✅ **依賴注入**: 便於測試和維護  
✅ **配置管理**: 支援多環境部署  
✅ **錯誤處理**: 統一的異常處理機制  
✅ **類型安全**: 使用 Pydantic 進行數據驗證  
✅ **可擴展性**: 新功能可以輕鬆添加  
✅ **可維護性**: 清晰的代碼結構和文檔  

這個架構為 ClinicSim-AI 的長期發展提供了堅實的基礎，支援團隊協作和功能擴展。
