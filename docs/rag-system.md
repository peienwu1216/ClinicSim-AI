# ğŸ“š RAG ç³»çµ±æ–‡æª”

> **æª¢ç´¢å¢å¼·ç”ŸæˆæŠ€è¡“å¯¦ç¾** | åŸºæ–¼è‡¨åºŠæŒ‡å¼•çš„æ™ºæ…§å ±å‘Šç”Ÿæˆ

## ğŸ¯ ç³»çµ±æ¦‚è¿°

ClinicSim-AI æ•´åˆäº† RAG (Retrieval-Augmented Generation) æŠ€è¡“ï¼Œèƒ½å¤ åœ¨ç”Ÿæˆè¨ºå¾Œåˆ†æå ±å‘Šæ™‚æä¾›åŸºæ–¼è‡¨åºŠæŒ‡å¼•çš„å°ˆæ¥­å»ºè­°ã€‚

### æ ¸å¿ƒåƒ¹å€¼
- **ğŸ” æ™ºæ…§æª¢ç´¢** - åŸºæ–¼èªç¾©ç›¸ä¼¼åº¦çš„çŸ¥è­˜æª¢ç´¢
- **ğŸ“ å¼•è¨»é€æ˜** - æ˜ç¢ºæ¨™ç¤ºçŸ¥è­˜ä¾†æº
- **ğŸ“ å°ˆæ¥­å»ºè­°** - åŸºæ–¼æ¬Šå¨è‡¨åºŠæŒ‡å¼•çš„å»ºè­°
- **âš¡ å³æ™‚æ•´åˆ** - èˆ‡ LLM ç„¡ç¸«æ•´åˆ

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### æ ¸å¿ƒçµ„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RAG ç³»çµ±æ¶æ§‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ documents/          ğŸ“ faiss_index/                 â”‚
â”‚  â”œâ”€â”€ è‡¨åºŠæŒ‡å¼•æ–‡ä»¶        â”œâ”€â”€ index.faiss               â”‚
â”‚  â”œâ”€â”€ OSCE æ¨™æº–          â”œâ”€â”€ index.pkl                 â”‚
â”‚  â””â”€â”€ è¨ºæ–·æµç¨‹           â””â”€â”€ å‘é‡è³‡æ–™åº«                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                RAG è™•ç†æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æ–‡æª”åˆ†å¡Š (Chunking)                                â”‚
â”‚  2. å‘é‡åŒ– (Embedding)                                 â”‚
â”‚  3. ç´¢å¼•å»ºç«‹ (Indexing)                                â”‚
â”‚  4. ç›¸ä¼¼åº¦æœå°‹ (Similarity Search)                     â”‚
â”‚  5. ä¸Šä¸‹æ–‡æ³¨å…¥ (Context Injection)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“æ£§

| çµ„ä»¶ | æŠ€è¡“ | ç”¨é€” |
|------|------|------|
| **æ–‡æª”è™•ç†** | PyPDF, LangChain | PDF è§£æå’Œæ–‡å­—æå– |
| **å‘é‡åŒ–** | HuggingFace Embeddings | æ–‡å­—è½‰æ›ç‚ºå‘é‡ |
| **ç´¢å¼•** | FAISS | é«˜æ•ˆå‘é‡æœå°‹ |
| **æª¢ç´¢** | LangChain | èªç¾©ç›¸ä¼¼åº¦æœå°‹ |
| **æ•´åˆ** | è‡ªå®šç¾©é‚è¼¯ | èˆ‡ LLM æ•´åˆ |

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. æº–å‚™çŸ¥è­˜æ–‡ä»¶

#### æ”¯æ´çš„æ–‡ä»¶æ ¼å¼
- **PDF** - è‡¨åºŠæŒ‡å¼•ã€æ•™ç§‘æ›¸ç« ç¯€
- **TXT** - ç´”æ–‡å­—æ ¼å¼çš„æŒ‡å¼•
- **MD** - Markdown æ ¼å¼çš„æ–‡æª”

#### æ–‡ä»¶æ”¾ç½®
```bash
documents/
â”œâ”€â”€ acute_chest_pain_guidelines.txt
â”œâ”€â”€ osce_evaluation_criteria.pdf
â”œâ”€â”€ clinical_decision_making.md
â””â”€â”€ emergency_protocols.txt
```

### 2. å»ºç«‹å‘é‡ç´¢å¼•

```bash
# åŸ·è¡Œç´¢å¼•å»ºç«‹è…³æœ¬
python build_index.py

# è¼¸å‡º
ğŸ’¡ [RAG] æ­£åœ¨å»ºç«‹å‘é‡ç´¢å¼•...
ğŸ“„ è™•ç†æ–‡ä»¶: acute_chest_pain_guidelines.txt
ğŸ”¢ åˆ†å¡Šæ•¸é‡: 45
ğŸ“Š å‘é‡ç¶­åº¦: 768
âœ… ç´¢å¼•å»ºç«‹å®Œæˆ: faiss_index/
```

### 3. ç³»çµ±æ•´åˆ

RAG ç³»çµ±æœƒè‡ªå‹•åœ¨æœå‹™å™¨å•Ÿå‹•æ™‚è¼‰å…¥ï¼š

```python
# rag_handler.py
class RAGSystem:
    def __init__(self):
        self._load_index()
    
    def search(self, query: str, k: int = 3) -> str:
        # åŸ·è¡Œç›¸ä¼¼åº¦æœå°‹
        results = self.vector_store.similarity_search(query, k=k)
        return self._format_results(results)
```

## ğŸ”§ é…ç½®å’Œåƒæ•¸

### ç´¢å¼•å»ºç«‹åƒæ•¸

```python
# build_index.py é…ç½®
CHUNK_SIZE = 1000        # æ–‡æª”åˆ†å¡Šå¤§å°
CHUNK_OVERLAP = 200      # åˆ†å¡Šé‡ç–Šå¤§å°
EMBEDDING_MODEL = "nomic-ai/nomic-embed-text-v1.5"  # åµŒå…¥æ¨¡å‹
SEARCH_K = 3             # æœå°‹çµæœæ•¸é‡
```

### æœå°‹åƒæ•¸

```python
# rag_handler.py é…ç½®
def search(self, query: str, k: int = 3) -> str:
    """
    Args:
        query: æœå°‹æŸ¥è©¢
        k: è¿”å›çµæœæ•¸é‡ (é è¨­ 3)
    """
    results = self.vector_store.similarity_search(query, k=k)
    return self._format_results(results)
```

## ğŸ“ ä½¿ç”¨ç¯„ä¾‹

### åŸºæœ¬æœå°‹

```python
from rag_handler import rag_system

# æœå°‹ç›¸é—œè‡¨åºŠæŒ‡å¼•
query = "æ€¥æ€§èƒ¸ç—›è¨ºæ–·æµç¨‹"
results = rag_system.search(query, k=3)

print(results)
# è¼¸å‡ºï¼š
# ä¾†æº: documents/acute_chest_pain_guidelines.txt
# å…§å®¹: æ€¥æ€§èƒ¸ç—›è‡¨åºŠæŒ‡å¼•
# 
# ## æ¦‚è¿°
# æ€¥æ€§èƒ¸ç—›æ˜¯æ€¥è¨ºç§‘æœ€å¸¸è¦‹çš„ä¸»è¨´ä¹‹ä¸€...
```

### åœ¨å ±å‘Šç”Ÿæˆä¸­ä½¿ç”¨

```python
# server.py ä¸­çš„æ•´åˆç¯„ä¾‹
def get_detailed_report(full_conversation, case_id):
    # 1. ç”Ÿæˆå¤šå€‹ç›¸é—œæŸ¥è©¢
    rag_queries = [
        "æ€¥æ€§èƒ¸ç—›è¨ºæ–·æµç¨‹å’Œæª¢æŸ¥é †åº",
        "ECG å¿ƒé›»åœ–åœ¨èƒ¸ç—›è©•ä¼°ä¸­çš„é‡è¦æ€§",
        "STEMI å’Œä¸ç©©å®šå‹å¿ƒçµç—›çš„è¨ºæ–·æ¨™æº–"
    ]
    
    # 2. æœå°‹ç›¸é—œçŸ¥è­˜
    rag_contexts = []
    citations = []
    
    for i, query in enumerate(rag_queries, 1):
        context = rag_system.search(query, k=2)
        citations.append({
            "id": i,
            "query": query,
            "source": f"è‡¨åºŠæŒ‡å¼• {i}",
            "content": context
        })
        rag_contexts.append(f"### é—œæ–¼ {query} [å¼•è¨» {i}]\n{context}")
    
    # 3. æ•´åˆåˆ° LLM Prompt
    combined_rag_context = "\n\n".join(rag_contexts)
    
    # 4. ç”Ÿæˆå ±å‘Š
    prompt = f"""
    åŸºæ–¼ä»¥ä¸‹è‡¨åºŠæŒ‡å¼•ç”Ÿæˆå ±å‘Šï¼š
    
    {combined_rag_context}
    
    è«‹å¼•ç”¨ç›¸æ‡‰çš„æŒ‡å¼•ï¼Œä½¿ç”¨ [å¼•è¨» X] æ ¼å¼ã€‚
    """
```

## ğŸ¨ å¼•è¨»ç³»çµ±

### å¼•è¨»æ ¼å¼

```markdown
æ ¹æ“š [å¼•è¨» 1] çš„è¨ºæ–·æµç¨‹æŒ‡å¼•ï¼š
- ECG å¿ƒé›»åœ–æª¢æŸ¥æ‡‰åœ¨ 10 åˆ†é˜å…§å®Œæˆ
- é€™æ˜¯æ€¥æ€§èƒ¸ç—›è©•ä¼°çš„ç¬¬ä¸€å„ªå…ˆæª¢æŸ¥

å¦‚ [å¼•è¨» 2] æ‰€è¿°ï¼Œå¿ƒé›»åœ–æ˜¯æ€¥æ€§èƒ¸ç—›è©•ä¼°çš„é—œéµå·¥å…·...
```

### å¼•è¨»è³‡æ–™çµæ§‹

```python
citation = {
    "id": 1,
    "query": "æ€¥æ€§èƒ¸ç—›è¨ºæ–·æµç¨‹",
    "source": "è‡¨åºŠæŒ‡å¼• 1",
    "content": "æ€¥æ€§èƒ¸ç—›è‡¨åºŠæŒ‡å¼•\n\n## æ¦‚è¿°\næ€¥æ€§èƒ¸ç—›æ˜¯æ€¥è¨ºç§‘æœ€å¸¸è¦‹çš„ä¸»è¨´..."
}
```

### å‰ç«¯é¡¯ç¤º

```python
# Streamlit å‰ç«¯ä¸­çš„å¼•è¨»é¡¯ç¤º
def display_citations(citations):
    for citation in citations:
        with st.expander(f"ğŸ“š [å¼•è¨» {citation['id']}] {citation['query']}"):
            st.markdown(f"**ä¾†æº**: {citation['source']}")
            st.markdown(f"**æŸ¥è©¢**: {citation['query']}")
            st.markdown("**å…§å®¹**:")
            st.markdown(citation['content'])
```

## âš¡ æ•ˆèƒ½å„ªåŒ–

### ç´¢å¼•å„ªåŒ–

```python
# èª¿æ•´åˆ†å¡Šåƒæ•¸ä»¥å¹³è¡¡æ•ˆèƒ½å’Œæº–ç¢ºæ€§
CHUNK_SIZE = 800        # è¼ƒå°çš„åˆ†å¡Šæé«˜ç²¾ç¢ºåº¦
CHUNK_OVERLAP = 150     # é©åº¦çš„é‡ç–Šç¢ºä¿é€£çºŒæ€§
```

### æœå°‹å„ªåŒ–

```python
# ä½¿ç”¨æ›´å¿«çš„åµŒå…¥æ¨¡å‹
EMBEDDING_MODEL = "sentence-transformers/all-MiniLM-L6-v2"  # æ›´å¿«çš„æ¨¡å‹

# èª¿æ•´æœå°‹åƒæ•¸
SEARCH_K = 5            # æ›´å¤šçµæœæé«˜è¦†è“‹ç‡
SIMILARITY_THRESHOLD = 0.7  # ç›¸ä¼¼åº¦é–¾å€¼éæ¿¾
```

### å¿«å–ç­–ç•¥

```python
# å¯¦ä½œæœå°‹çµæœå¿«å–
from functools import lru_cache

@lru_cache(maxsize=100)
def cached_search(query: str, k: int) -> str:
    return rag_system.search(query, k)
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### 1. ç´¢å¼•å»ºç«‹å¤±æ•—
```bash
# éŒ¯èª¤ï¼šè¨˜æ†¶é«”ä¸è¶³
# è§£æ±ºï¼šæ¸›å°‘åˆ†å¡Šå¤§å°
CHUNK_SIZE = 500

# éŒ¯èª¤ï¼šæª”æ¡ˆæ ¼å¼ä¸æ”¯æ´
# è§£æ±ºï¼šè½‰æ›ç‚º TXT æ ¼å¼
```

#### 2. æœå°‹çµæœç‚ºç©º
```bash
# æª¢æŸ¥ç´¢å¼•ç‹€æ…‹
curl http://localhost:5001/rag/status

# é‡æ–°å»ºç«‹ç´¢å¼•
python build_index.py
```

#### 3. æœå°‹é€Ÿåº¦æ…¢
```bash
# ä½¿ç”¨æ›´å¿«çš„åµŒå…¥æ¨¡å‹
# æ¸›å°‘æœå°‹çµæœæ•¸é‡
# å•Ÿç”¨å¿«å–æ©Ÿåˆ¶
```

### è¨ºæ–·å·¥å…·

```python
# RAG ç³»çµ±è¨ºæ–·
def diagnose_rag_system():
    print("ğŸ” RAG ç³»çµ±è¨ºæ–·")
    print(f"ç´¢å¼•è·¯å¾‘: {rag_system.index_path}")
    print(f"åµŒå…¥æ¨¡å‹: {rag_system.model_name}")
    print(f"å‘é‡å­˜å„²: {'å·²è¼‰å…¥' if rag_system.vector_store else 'æœªè¼‰å…¥'}")
    
    # æ¸¬è©¦æœå°‹
    test_query = "èƒ¸ç—›è¨ºæ–·"
    result = rag_system.search(test_query, k=1)
    print(f"æ¸¬è©¦æœå°‹: {'æˆåŠŸ' if result else 'å¤±æ•—'}")
```

## ğŸš€ é€²éšåŠŸèƒ½

### å¤šèªè¨€æ”¯æ´

```python
# æ”¯æ´å¤šèªè¨€åµŒå…¥æ¨¡å‹
EMBEDDING_MODELS = {
    "zh": "sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2",
    "en": "sentence-transformers/all-MiniLM-L6-v2"
}
```

### å‹•æ…‹ç´¢å¼•æ›´æ–°

```python
# æ”¯æ´å¢é‡æ›´æ–°ç´¢å¼•
def update_index(new_documents):
    """å¢é‡æ›´æ–°ç´¢å¼•"""
    # è™•ç†æ–°æ–‡æª”
    # æ·»åŠ åˆ°ç¾æœ‰ç´¢å¼•
    # é‡æ–°ä¿å­˜ç´¢å¼•
```

### æ··åˆæª¢ç´¢

```python
# çµåˆé—œéµå­—å’Œèªç¾©æœå°‹
def hybrid_search(query: str):
    # é—œéµå­—æœå°‹
    keyword_results = keyword_search(query)
    
    # èªç¾©æœå°‹
    semantic_results = semantic_search(query)
    
    # çµæœèåˆ
    return merge_results(keyword_results, semantic_results)
```

## ğŸ“Š ç›£æ§å’Œåˆ†æ

### ä½¿ç”¨çµ±è¨ˆ

```python
# è¨˜éŒ„æœå°‹çµ±è¨ˆ
search_stats = {
    "total_searches": 0,
    "avg_response_time": 0.0,
    "popular_queries": [],
    "citation_usage": {}
}
```

### æ•ˆèƒ½æŒ‡æ¨™

- **æœå°‹å»¶é²** - å¹³å‡æœå°‹å›æ‡‰æ™‚é–“
- **å‘½ä¸­ç‡** - æœ‰æ•ˆæœå°‹çµæœæ¯”ä¾‹
- **å¼•è¨»ä½¿ç”¨ç‡** - å¼•è¨»åœ¨å ±å‘Šä¸­çš„ä½¿ç”¨æƒ…æ³
- **ç”¨æˆ¶æ»¿æ„åº¦** - åŸºæ–¼åé¥‹çš„å“è³ªè©•ä¼°

---

**RAG ç³»çµ±æ˜¯ ClinicSim-AI çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œç‚ºç”¨æˆ¶æä¾›åŸºæ–¼æ¬Šå¨è‡¨åºŠæŒ‡å¼•çš„å°ˆæ¥­å»ºè­°ï¼** ğŸ‰
